<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>exp_diff</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="exp_diff_files/libs/clipboard/clipboard.min.js"></script>
<script src="exp_diff_files/libs/quarto-html/quarto.js"></script>
<script src="exp_diff_files/libs/quarto-html/popper.min.js"></script>
<script src="exp_diff_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="exp_diff_files/libs/quarto-html/anchor.min.js"></script>
<link href="exp_diff_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="exp_diff_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="exp_diff_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="exp_diff_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="exp_diff_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<section id="table-of-contents" class="level1">
<h1>Table of contents</h1>
<ol type="1">
<li><a href="#intro">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#methods">Methods</a>
<ol type="1">
<li><a href="#org-tangent">Original tangent approximation</a></li>
<li><a href="#adapted-tangent">Adapted tangent approximation</a></li>
<li><a href="#finite-diff">Finite difference approximation</a></li>
</ol></li>
</ol>
</section>
<section id="introduction-differentiation-of-matrix-exp-for-weighted-gnms" class="level1">
<h1>Introduction: Differentiation of matrix exp for weighted GNMs <a name="intro" href=""></a></h1>
<p>From: https://www.biorxiv.org/content/10.1101/2023.06.23.546237v1?med=mas.</p>
<p>This is mostly concerned with finding the fastest way to compute the derivative of the matrix exponential. <span class="math display">\[
f(w_{i,j}) = (c_{i,k} * d_{i,j})^{\omega}
\]</span> Where, the communicability matrix is defined as follows. This captures the proportion of signals, that propagate randomly from node i would reach node j over an infinite time horizon. <span class="math display">\[
c_{i,j} = e^{s^{-1/2}w_{i,j}s^{-1/2}}
\]</span></p>
<p>In this demonstration, we will simply work on the matrix exponential differentiation: <span class="math display">\[
f(W)=e^{W}
\]</span></p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup <a name="setup" href=""></a></h2>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Polynomials</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ForwardDiff</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ExponentialUtilities</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> [<span class="fl">0.0</span> <span class="fl">0.8</span> <span class="fl">0.0</span>;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0.8</span> <span class="fl">0.0</span> <span class="fl">0.2</span>; </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0.0</span> <span class="fl">0.2</span> <span class="fl">0.0</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>demo_edge <span class="op">=</span> [<span class="fu">CartesianIndex</span>(<span class="fl">1</span>, <span class="fl">2</span>)]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>W</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>3×3 Matrix{Float64}:
 0.0  0.8  0.0
 0.8  0.0  0.2
 0.0  0.2  0.0</code></pre>
</div>
</div>
</section>
</section>
<section id="methods" class="level1">
<h1>Methods <a name="methods" href=""></a></h1>
<section id="original-tangent-approximation" class="level2">
<h2 class="anchored" data-anchor-id="original-tangent-approximation">Original tangent approximation <a name="org-tangent" href=""></a></h2>
<p>Here we are computing the derivative for a single edge. We will use the tangent approximation to compute the derivative. This is the approach used in the Akarca paper.</p>
<p><strong>Problem 1</strong> As far as I understand, there is a small but significant error in the implementation provided at https://github.com/DanAkarca/weighted_generative_models/blob/main/weighted_generative_model.m in line 197. When fitting the first-order polynomial, the independent variable should not be the range of the differences to the edge, which have been used, but should be the actual values, the edge is taking on.</p>
<p><strong>Problem 2</strong> In the same implementation the derivative is approximated from the tangent approximation after nudging the edge (i,j) as well as (j,i). In a sense we are computing the derivative with respect to both (i,j) and (j,i) at once. First of all, this will create computational overhead, as the derivatives (i.e., the jacobian) will also always be symmetric. Secondly, this will create a problem when we are trying to compute the gradient, which we currently simply take as the the derivative. But then we update both elements in the W matrix with the same gradient which is the derivative with respect to nudging both (i,j) and (j,i) - thus our update to the objective function is overshooting.</p>
<p>See line 208 and 208.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">paper_tangent_approx</span>(W, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>, resolution <span class="op">=</span> <span class="fl">0.01</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">0.25</span>, max <span class="op">=</span> <span class="fl">0.25</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    rep_vec <span class="op">=</span> <span class="fu">collect</span>(min<span class="op">:</span>resolution<span class="op">:</span>max)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge_idx) <span class="kw">in</span> <span class="fu">enumerate</span>(edges)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Points for evaluation</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        edge_val <span class="op">=</span> W[edge_idx]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        reps <span class="op">=</span> [edge_val <span class="op">*</span> (<span class="fl">1</span> <span class="op">+</span> i) for i <span class="kw">in</span> rep_vec]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each nudge save difference in communicability </span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        sum_comm <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(reps))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_rep, rep) <span class="kw">in</span> <span class="fu">enumerate</span>(reps)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            W_copy <span class="op">=</span> <span class="fu">copy</span>(W)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            W_copy[edge_idx] <span class="op">=</span> W_copy[edge_idx[<span class="fl">2</span>], edge_idx[<span class="fl">1</span>]] <span class="op">=</span> rep</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            comm <span class="op">=</span> <span class="fu">exp</span>(W_copy)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            sum_comm[i_rep] <span class="op">=</span> <span class="fu">sum</span>(comm)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Line 197 in MATLAB code</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(reps)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> <span class="fu">fit</span>(x, sum_comm, <span class="fl">1</span>)[<span class="fl">1</span>]</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="fu">paper_tangent_approx</span>(W, demo_edge, <span class="fl">0.01</span>), <span class="fu">paper_tangent_approx</span>(W, demo_edge, <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>([0.038767237882607476], [0.7456781939183535])</code></pre>
</div>
</div>
</section>
<section id="adapted-tangent-approximation" class="level2">
<h2 class="anchored" data-anchor-id="adapted-tangent-approximation">Adapted tangent approximation <a name="adapted-tangent" href=""></a></h2>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">tangent_approx</span>(W, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    resolution <span class="op">=</span> <span class="fl">0.01</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">0.25</span>, max <span class="op">=</span> <span class="fl">0.25</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    rep_vec <span class="op">=</span> <span class="fu">collect</span>(min<span class="op">:</span>resolution<span class="op">:</span>max)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge_idx) <span class="kw">in</span> <span class="fu">enumerate</span>(edges)     </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Points for evaluation</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        edge_val <span class="op">=</span> W[edge_idx]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        reps <span class="op">=</span> [edge_val <span class="op">*</span> (<span class="fl">1</span> <span class="op">+</span> i) for i <span class="kw">in</span> rep_vec]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each nudge save difference in communicability </span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        sum_comm <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(reps))</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_rep, rep) <span class="kw">in</span> <span class="fu">enumerate</span>(reps)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            W_copy <span class="op">=</span> <span class="fu">copy</span>(W)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            W_copy[edge_idx] <span class="op">=</span> W_copy[edge_idx[<span class="fl">2</span>], edge_idx[<span class="fl">1</span>]] <span class="op">=</span> rep</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            comm <span class="op">=</span> <span class="fu">exp</span>(W_copy)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            sum_comm[i_rep] <span class="op">=</span> <span class="fu">sum</span>(comm)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> <span class="fu">fit</span>(reps, sum_comm, <span class="fl">1</span>)[<span class="fl">1</span>]</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="fu">tangent_approx</span>(W, demo_edge, <span class="fl">0.01</span>), <span class="fu">tangent_approx</span>(W, demo_edge, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>([4.8459047353259335], [4.851647952441173])</code></pre>
</div>
</div>
</section>
<section id="finite-difference-method" class="level2">
<h2 class="anchored" data-anchor-id="finite-difference-method">Finite difference method <a name="finite-diff" href=""></a></h2>
<p>Compute the approximate derivative using the finite difference method. https://en.wikipedia.org/wiki/Finite_difference_method</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">finite_diff</span>(W, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>, delta<span class="op">::</span><span class="dt">Float64</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge_idx) <span class="kw">in</span> <span class="fu">enumerate</span>(edges) </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate the function at two nearby points</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        W_copy <span class="op">=</span> <span class="fu">copy</span>(W)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        W_copy[edge_idx]  <span class="op">=</span> W_copy[edge_idx] <span class="op">+</span> delta</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        f_plus_delta <span class="op">=</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W_copy))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        W_copy[edge_idx]  <span class="op">=</span> W_copy[edge_idx] <span class="op">-</span> <span class="fl">2</span><span class="op">*</span>delta</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        f_minus_delta <span class="op">=</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W_copy))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the derivative approximation</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> (f_plus_delta <span class="op">-</span> f_minus_delta) <span class="op">/</span> (<span class="fl">2</span> <span class="op">*</span> delta)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="fu">finite_diff</span>(W, demo_edge, <span class="fl">0.01</span>)<span class="op">*</span><span class="fl">2</span>, <span class="fu">finite_diff</span>(W, demo_edge,<span class="fl">0.2</span>)<span class="op">*</span><span class="fl">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>([4.826503769214696], [4.827101432180703])</code></pre>
</div>
</div>
</section>
<section id="forward-differentiation" class="level2">
<h2 class="anchored" data-anchor-id="forward-differentiation">Forward Differentiation</h2>
<p>Results are derived in the numerator layout, which means that the dimensionality of the input is added to the right</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">forward_diff_j</span>(W<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Column indices for retrieval</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">CartesianIndices</span>(W))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    index_vec <span class="op">=</span> <span class="fu">sort</span>(<span class="fu">vec</span>(indices), by <span class="op">=</span> x <span class="op">-&gt;</span> x[<span class="fl">1</span>])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diff_exp</span>(W) <span class="op">=</span> <span class="fu">exponential!</span>(<span class="fu">copyto!</span>(<span class="fu">similar</span>(W), W), <span class="fu">ExpMethodGeneric</span>())</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    J <span class="op">=</span> ForwardDiff.<span class="fu">jacobian</span>(diff_exp, W)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    tangent <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">permutedims</span>(<span class="fu">exp</span>(W), [<span class="fl">2</span>, <span class="fl">1</span>]))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge) <span class="kw">in</span> <span class="fu">enumerate</span>(edges)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we get all partial derivative positions that are non-zero</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        Jₓ <span class="op">=</span> J[<span class="op">:</span>, <span class="fu">findfirst</span>(x <span class="op">-&gt;</span> x <span class="op">==</span> edge, index_vec)]</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> <span class="fu">dot</span>(Jₓ, tangent)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results <span class="op">.*</span> <span class="fl">2</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="fu">forward_diff_j</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1-element Vector{Float64}:
 4.8612290825962985</code></pre>
</div>
</div>
</section>
<section id="forward-differentiation-with-jacobian-vector-product" class="level2">
<h2 class="anchored" data-anchor-id="forward-differentiation-with-jacobian-vector-product">Forward Differentiation with Jacobian vector product</h2>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">forward_diff_jvp</span>(W<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    tangent <span class="op">=</span> <span class="fu">exp</span>(W)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diff_exp</span>(W) <span class="op">=</span> <span class="fu">exponential!</span>(<span class="fu">copyto!</span>(<span class="fu">similar</span>(W), W), <span class="fu">ExpMethodGeneric</span>())</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">g</span>(t) <span class="op">=</span> <span class="fu">diff_exp</span>(W <span class="op">+</span> t <span class="op">*</span> tangent)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    JVP <span class="op">=</span> ForwardDiff.<span class="fu">derivative</span>(g, <span class="fl">0.0</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> JVP[edges] <span class="op">.*</span> <span class="fl">2</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">forward_diff_jvp</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1-element Vector{Float64}:
 4.861229082596298</code></pre>
</div>
</div>
</section>
<section id="fréchet-block-enlarge" class="level2">
<h2 class="anchored" data-anchor-id="fréchet-block-enlarge">Fréchet: Block enlarge</h2>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">frechet_block_enlarge</span>(W<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    E <span class="op">=</span> <span class="fu">exp</span>(W)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="fu">size</span>(W, <span class="fl">1</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> [W E; <span class="fu">zeros</span>(<span class="fu">size</span>(W)) W]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    expm_M <span class="op">=</span> <span class="fu">exp</span>(M) </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    frechet_AE <span class="op">=</span> expm_M[<span class="fl">1</span><span class="op">:</span>n, n<span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frechet_AE[edges] <span class="op">.*</span> <span class="fl">2</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">frechet_block_enlarge</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1-element Vector{Float64}:
 4.861229082596298</code></pre>
</div>
</div>
</section>
<section id="fréchet-scaling-pade-squaring" class="level2">
<h2 class="anchored" data-anchor-id="fréchet-scaling-pade-squaring">Fréchet: Scaling-Pade-Squaring</h2>
<p>Higham (2008): Functions of Matrices - Theory and Computation”, Chapter 10, Algorithm 10.20</p>
<p>Also inspired by https://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.expm_frechet.html#scipy.linalg.expm_frechet.</p>
<p>Also inspired by https://rdrr.io/cran/expm/man/expmFrechet.html</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade3</span>(A, E, ident)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">120.0</span>, <span class="fl">60.0</span>, <span class="fl">12.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade5</span>(A, E, ident)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">30240.0</span>, <span class="fl">15120.0</span>, <span class="fl">3360.0</span>, <span class="fl">420.0</span>, <span class="fl">30.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade7</span>(A, E, ident)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">17297280.0</span>, <span class="fl">8648640.0</span>, <span class="fl">1995840.0</span>, <span class="fl">277200.0</span>, <span class="fl">25200.0</span>, <span class="fl">1512.0</span>, <span class="fl">56.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    A6 <span class="op">=</span> A2 <span class="op">*</span> A4</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    M6 <span class="op">=</span> A4 <span class="op">*</span> M2 <span class="op">+</span> M4 <span class="op">*</span> A2</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">8</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade9</span>(A, E, ident)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">17643225600.0</span>, <span class="fl">8821612800.0</span>, <span class="fl">2075673600.0</span>, <span class="fl">302702400.0</span>, <span class="fl">30270240.0</span>, <span class="fl">2162160.0</span>, <span class="fl">110880.0</span>, <span class="fl">3960.0</span>, <span class="fl">90.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    A6 <span class="op">=</span> A2 <span class="op">*</span> A4</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    M6 <span class="op">=</span> A4 <span class="op">*</span> M2 <span class="op">+</span> M4 <span class="op">*</span> A2</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    A8 <span class="op">=</span> A4 <span class="op">*</span> A4</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    M8 <span class="op">=</span> A4 <span class="op">*</span> M4 <span class="op">+</span> M4 <span class="op">*</span> A4</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">10</span>] <span class="op">*</span> A8 <span class="op">+</span> b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">9</span>] <span class="op">*</span> A8 <span class="op">+</span> b[<span class="fl">7</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">10</span>] <span class="op">*</span> M8 <span class="op">+</span> b[<span class="fl">8</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">10</span>] <span class="op">*</span> A8 <span class="op">+</span> b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">9</span>] <span class="op">*</span> M8 <span class="op">+</span> b[<span class="fl">7</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>ell_table_61 <span class="op">=</span> (</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        <span class="cn">nothing</span>,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        <span class="fl">2.11e-8</span>,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        <span class="fl">3.56e-4</span>,</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.08e-2</span>,</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>        <span class="fl">6.49e-2</span>,</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>        <span class="fl">2.00e-1</span>,</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>        <span class="fl">4.37e-1</span>,</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>        <span class="fl">7.83e-1</span>,</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.23e0</span>,</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.78e0</span>,</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>        <span class="fl">2.42e0</span>,</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 11</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>        <span class="fl">3.13e0</span>,</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>        <span class="fl">3.90e0</span>,</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>        <span class="fl">4.74e0</span>,</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>        <span class="fl">5.63e0</span>,</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>        <span class="fl">6.56e0</span>,</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>        <span class="fl">7.52e0</span>,</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>        <span class="fl">8.53e0</span>,</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>        <span class="fl">9.56e0</span>,</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.06e1</span>,</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.17e1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(nothing, 2.11e-8, 0.000356, 0.0108, 0.0649, 0.2, 0.437, 0.783, 1.23, 1.78, 2.42, 3.13, 3.9, 4.74, 5.63, 6.56, 7.52, 8.53, 9.56, 10.6, 11.7)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">frechet_algo</span>(A<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    E <span class="op">=</span> <span class="fu">exp</span>(A)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="fu">size</span>(A, <span class="fl">1</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="cn">nothing</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    ident <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Float64}</span>(I, n, n)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    A_norm_1 <span class="op">=</span> <span class="fu">norm</span>(A, <span class="fl">1</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    m_pade_pairs <span class="op">=</span> [</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">3</span>, _diff_pade3),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">5</span>, _diff_pade5),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">7</span>, _diff_pade7),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">9</span>, _diff_pade9)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m, pade) <span class="kw">in</span> m_pade_pairs</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> A_norm_1 <span class="op">&lt;=</span> ell_table_61[m]</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            U, V, Lu, Lv <span class="op">=</span> <span class="fu">pade</span>(A, E, ident)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> s <span class="op">==</span> <span class="cn">nothing</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># scaling</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> <span class="fu">max</span>(<span class="fl">0</span>, <span class="fu">ceil</span>(<span class="dt">Int</span>, <span class="fu">log2</span>(A_norm_1 <span class="op">/</span> ell_table_61[<span class="fl">13</span>])))</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        A <span class="op">*=</span> <span class="fl">2.0</span><span class="op">^-</span>s</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        E <span class="op">*=</span> <span class="fl">2.0</span><span class="op">^-</span>s</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># pade order 13</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        A6 <span class="op">=</span> A2 <span class="op">*</span> A4</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        M6 <span class="op">=</span> A4 <span class="op">*</span> M2 <span class="op">+</span> M4 <span class="op">*</span> A2</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> (<span class="fl">64764752532480000</span>., <span class="fl">32382376266240000</span>., <span class="fl">7771770303897600</span>.,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>                <span class="fl">1187353796428800</span>., <span class="fl">129060195264000</span>., <span class="fl">10559470521600</span>.,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>                <span class="fl">670442572800</span>., <span class="fl">33522128640</span>., <span class="fl">1323241920</span>., <span class="fl">40840800</span>., <span class="fl">960960</span>.,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>                <span class="fl">16380</span>., <span class="fl">182</span>., <span class="fl">1</span>.)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>        W1 <span class="op">=</span> b[<span class="fl">14</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">12</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">10</span>] <span class="op">*</span> A2</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>        W2 <span class="op">=</span> b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        Z1 <span class="op">=</span> b[<span class="fl">13</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">11</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">9</span>] <span class="op">*</span> A2</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        Z2 <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        W <span class="op">=</span> A6 <span class="op">*</span> W1 <span class="op">+</span> W2</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        U <span class="op">=</span> A <span class="op">*</span> W</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> A6 <span class="op">*</span> Z1 <span class="op">+</span> Z2</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        Lw1 <span class="op">=</span> b[<span class="fl">14</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">12</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">10</span>] <span class="op">*</span> M2</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        Lw2 <span class="op">=</span> b[<span class="fl">8</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        Lz1 <span class="op">=</span> b[<span class="fl">13</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">11</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">9</span>] <span class="op">*</span> M2</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        Lz2 <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        Lw <span class="op">=</span> A6 <span class="op">*</span> Lw1 <span class="op">+</span> M6 <span class="op">*</span> W1 <span class="op">+</span> Lw2</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        Lu <span class="op">=</span> A <span class="op">*</span> Lw <span class="op">+</span> E <span class="op">*</span> W</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>        Lv <span class="op">=</span> A6 <span class="op">*</span> Lz1 <span class="op">+</span> M6 <span class="op">*</span> Z1 <span class="op">+</span> Lz2</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># factor once and solve twice</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    lu_piv <span class="op">=</span> <span class="fu">lu</span>(<span class="op">-</span>U <span class="op">+</span> V)</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> lu_piv <span class="op">\</span> (U <span class="op">+</span> V)</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> lu_piv <span class="op">\</span> (Lu <span class="op">+</span> Lv <span class="op">+</span> ((Lu <span class="op">-</span> Lv) <span class="op">*</span> R))</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># squaring</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>s</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>        L <span class="op">=</span> R <span class="op">*</span> L <span class="op">+</span> L <span class="op">*</span> R</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L[edges] <span class="op">.*</span><span class="fl">2</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="fu">frechet_algo</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1-element Vector{Float64}:
 4.861229082596298</code></pre>
</div>
</div>
</section>
</section>
<section id="benchmarking" class="level1">
<h1>Benchmarking <a name="benchmarking" href=""></a></h1>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">init_sparse_matrix</span>(n <span class="op">=</span> <span class="fl">100</span>, density <span class="op">=</span> <span class="fl">0.2</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize a sparse matrix</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> <span class="fu">zeros</span>(n, n)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n, j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">rand</span>() <span class="op">&lt;</span> (density <span class="op">/</span> <span class="fl">2</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            W[i, j] <span class="op">=</span> W[j,i] <span class="op">=</span> <span class="fu">rand</span>()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> W</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>W_bench <span class="op">=</span> <span class="fu">init_sparse_matrix</span>(<span class="fl">50</span>, <span class="fl">0.10</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>edges_bench <span class="op">=</span> <span class="fu">findall</span>(x <span class="op">-&gt;</span> x <span class="op">!=</span> <span class="fl">0</span>, W_bench)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">tangent_approx</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench, <span class="fl">0.01</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">finite_diff</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench, <span class="fl">0.1</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">forward_diff_j</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">forward_diff_jvp</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  2.608 s (279080 allocations: 1.83 GiB)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  88.504 ms (7743 allocations: 60.52 MiB)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  1.728 s (5961 allocations: 312.16 MiB)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  1.700 ms (39 allocations: 432.30 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>241-element Vector{Float64}:
  9.435189136678718
  5.195743270503177
 13.467930447408666
  4.729657826331669
 37.97108049898049
 35.63246316466708
 40.14988627804099
 52.20936212065478
 61.064680835548295
 22.35336492281464
  ⋮
 14.609734107238188
 17.08779448253476
 34.43686560573628
 11.032408188686084
 22.008071742700885
 25.426604501682263
  6.7603142647465155
  7.540743730991197
 20.12146474452763</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>