<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>exp_diff</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="exp_diff_files/libs/clipboard/clipboard.min.js"></script>
<script src="exp_diff_files/libs/quarto-html/quarto.js"></script>
<script src="exp_diff_files/libs/quarto-html/popper.min.js"></script>
<script src="exp_diff_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="exp_diff_files/libs/quarto-html/anchor.min.js"></script>
<link href="exp_diff_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="exp_diff_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="exp_diff_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="exp_diff_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="exp_diff_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<section id="table-of-contents" class="level1">
<h1>Table of contents</h1>
<ol type="1">
<li><a href="#intro">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#methods">Methods</a>
<ol type="1">
<li><a href="#org-tangent">Original tangent approximation</a></li>
<li><a href="#adapted-tangent">Adapted tangent approximation</a></li>
<li><a href="#finite-diff">Finite difference approximation</a></li>
</ol></li>
</ol>
</section>
<section id="introduction-differentiation-of-matrix-exp-for-weighted-gnms" class="level1">
<h1>Introduction: Differentiation of matrix exp for weighted GNMs <a name="intro" href=""></a></h1>
<p>From: https://www.biorxiv.org/content/10.1101/2023.06.23.546237v1?med=mas.</p>
<p>This is mostly concerned with finding the fastest way to compute the derivative of the matrix exponential. <span class="math display">\[
f(w_{i,j}) = (c_{i,k} * d_{i,j})^{\omega}
\]</span> Where, the communicability matrix is defined as follows. This captures the proportion of signals, that propagate randomly from node i would reach node j over an infinite time horizon. <span class="math display">\[
c_{i,j} = e^{s^{-1/2}w_{i,j}s^{-1/2}}
\]</span></p>
<p>Finally, the update rule is given as: <span class="math display">\[
w_{i,j} = w_{i,j} - \alpha f'(w_{i,j})
\]</span></p>
<p><strong>Question</strong><br> In the code implementation this seems to be bound to zero in Line 110, but there is no upper bound, should it be normalized to range [0,1]?</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup <a name="setup" href=""></a></h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Polynomials</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ForwardDiff</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ExponentialUtilities</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StatsBase</span>: sample</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">"test_data.jl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>load_weight_test_data (generic function with 1 method)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> [<span class="fl">0.0</span> <span class="fl">0.8</span> <span class="fl">0.0</span>;</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0.8</span> <span class="fl">0.0</span> <span class="fl">0.2</span>; </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0.0</span> <span class="fl">0.2</span> <span class="fl">0.0</span>]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>demo_edge <span class="op">=</span> [<span class="fu">CartesianIndex</span>(<span class="fl">1</span>, <span class="fl">2</span>)]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>W</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>3×3 Matrix{Float64}:
 0.0  0.8  0.0
 0.8  0.0  0.2
 0.0  0.2  0.0</code></pre>
</div>
</div>
</section>
</section>
<section id="methods" class="level1">
<h1>Methods <a name="methods" href=""></a></h1>
<p>Here we will work on different approaches as to compute the derivative. In this demonstration, we will simply work on the matrix exponential differentiation, as the rest of the operation is trivial and computationally cheap.</p>
<p>For: <span class="math display">\[
f(W)=e^{W}
\]</span> Find <span class="math display">\[
\frac{\delta f}{\delta W_{i,j}}
\]</span> Or more specifically <span class="math display">\[
f(W)=\sum_{i,j} e^{W}
\]</span></p>
<p>But this also simply boils down to the evaluation of the derivative at one (a matrix of ones at the same size as W for the jacobian vector product).</p>
<section id="original-tangent-approximation" class="level2">
<h2 class="anchored" data-anchor-id="original-tangent-approximation">Original tangent approximation <a name="org-tangent" href=""></a></h2>
<p>Here we are computing the derivative for a single edge. We will use the tangent approximation to compute the derivative. This is the approach used in the Akarca paper and available in the repo, as can be seen below this will not produce the correct result.</p>
<p><strong>Problem 1</strong><br> As far as I understand, there is a small but significant error in the implementation provided at https://github.com/DanAkarca/weighted_generative_models/blob/main/weighted_generative_model.m in line 197. When fitting the first-order polynomial, the independent variable should not be the range of the differences to the edge, which have been used, but should be the actual values, the edge is taking on.</p>
<p><strong>Problem 2</strong><br> The second problem is that we will often need to compute the derivative with respect to a value in the matrix, which is currently zero. (This happens easily as the value for any weight has a lower bound of zero which is often hit). Now the approach implemented in the code builds a range of x value by using a value for the number of repititions and resolutions for the tangent approximations, but it multiples the resolution with the current x-value, which will produce a vector of zeros whenever the current value is zero, which will always produce a zero slope and zero derivative approximations - which is wrong.</p>
<p><strong>Problem 2</strong> In the same implementation the derivative is approximated from the tangent approximation after nudging the edge (i,j) as well as (j,i). In a sense we are computing the derivative with respect to both (i,j) and (j,i) at once. First of all, this will create computational overhead, as the derivatives (i.e., the jacobian) will also always be symmetric. Secondly, this will create a problem when we are trying to compute the gradient, which we currently simply take as the the derivative. But then we update both elements in the W matrix with the same gradient which is the derivative with respect to nudging both (i,j) and (j,i) - thus our update to the objective function is overshooting.</p>
<p>See line 208 and 208.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">paper_tangent_approx</span>(W, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    resolution <span class="op">=</span> <span class="fl">0.01</span>, steps <span class="op">=</span> <span class="fl">5</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    rep_vec <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">range</span>(<span class="op">-</span>steps<span class="op">*</span>resolution, steps<span class="op">*</span>resolution, step<span class="op">=</span>resolution))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge_idx) <span class="kw">in</span> <span class="fu">enumerate</span>(edges)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Points for evaluation</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        edge_val <span class="op">=</span> W[edge_idx]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        reps <span class="op">=</span> [edge_val <span class="op">*</span> (<span class="fl">1</span> <span class="op">+</span> i) for i <span class="kw">in</span> rep_vec]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each nudge save difference in communicability </span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        sum_comm <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(reps))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_rep, rep) <span class="kw">in</span> <span class="fu">enumerate</span>(reps)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            W_copy <span class="op">=</span> <span class="fu">copy</span>(W)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            W_copy[edge_idx] <span class="op">=</span> W_copy[edge_idx[<span class="fl">2</span>], edge_idx[<span class="fl">1</span>]] <span class="op">=</span> rep</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>            comm <span class="op">=</span> <span class="fu">exp</span>(W_copy)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            sum_comm[i_rep] <span class="op">=</span> <span class="fu">sum</span>(comm)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Line 197 in MATLAB code</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(reps)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> <span class="fu">fit</span>(x, sum_comm, <span class="fl">1</span>)[<span class="fl">1</span>]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="fu">paper_tangent_approx</span>(W, demo_edge, <span class="fl">0.01</span>), <span class="fu">paper_tangent_approx</span>(W, demo_edge, <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>([0.03861909629029788], [0.830380354061412])</code></pre>
</div>
</div>
</section>
<section id="adapted-tangent-approximation" class="level2">
<h2 class="anchored" data-anchor-id="adapted-tangent-approximation">Adapted tangent approximation <a name="adapted-tangent" href=""></a></h2>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">tangent_approx</span>(f<span class="op">::</span><span class="dt">Function</span>, W<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    resolution <span class="op">=</span> <span class="fl">0.01</span>, steps <span class="op">=</span> <span class="fl">5</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    rep_vec <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">range</span>(<span class="op">-</span>steps<span class="op">*</span>resolution, steps<span class="op">*</span>resolution, step<span class="op">=</span>resolution))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge_idx) <span class="kw">in</span> <span class="fu">enumerate</span>(edges)     </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Points for evaluation</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        edge_val <span class="op">=</span> W[edge_idx]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        sign_edge <span class="op">=</span> <span class="fu">sign</span>(edge_val) <span class="op">==</span> <span class="fl">0</span> ? <span class="fl">1</span> <span class="op">:</span> <span class="fu">sign</span>(edge_val)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        reps <span class="op">=</span> [edge_val <span class="op">+</span> sign_edge <span class="op">*</span> (<span class="fu">max</span>(<span class="fu">abs</span>(edge_val), <span class="fl">1e-3</span>) <span class="op">*</span> i) for i <span class="kw">in</span> rep_vec]</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each nudge save difference in communicability </span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        sum_comm <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(reps))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_rep, rep) <span class="kw">in</span> <span class="fu">enumerate</span>(reps)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            W_copy <span class="op">=</span> <span class="fu">copy</span>(W)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            W_copy[edge_idx] <span class="op">=</span> rep </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            sum_comm[i_rep] <span class="op">=</span> <span class="fu">f</span>(W_copy, edge_idx)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> <span class="fu">fit</span>(reps, sum_comm, <span class="fl">1</span>)[<span class="fl">1</span>]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> (W, _) <span class="op">-&gt;</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W))</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="fu">tangent_approx</span>(f, W, demo_edge, <span class="fl">0.01</span>), <span class="fu">tangent_approx</span>(f, W, demo_edge, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>([2.4132596676512077], [2.4141043556312676])</code></pre>
</div>
</div>
</section>
<section id="finite-difference-method" class="level2">
<h2 class="anchored" data-anchor-id="finite-difference-method">Finite difference method <a name="finite-diff" href=""></a></h2>
<p>Compute the approximate derivative using the finite difference method. At the moment, this is a significantly faster but less accurate method than the tangent approximation. Only implemented to be potentially extended to complex step approximation.</p>
<p>References:<br> https://en.wikipedia.org/wiki/Finite_difference_method</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">finite_diff</span>(f, W, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>, delta<span class="op">::</span><span class="dt">Float64</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge_idx) <span class="kw">in</span> <span class="fu">enumerate</span>(edges) </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate the function at two nearby points</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        W_copy <span class="op">=</span> <span class="fu">copy</span>(W)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        W_copy[edge_idx] <span class="op">=</span> W_copy[edge_idx] <span class="op">+</span> delta</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        f_plus_delta <span class="op">=</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W_copy))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        W_copy[edge_idx]  <span class="op">=</span> W_copy[edge_idx] <span class="op">-</span> <span class="fl">2</span><span class="op">*</span>delta</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        f_minus_delta <span class="op">=</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W_copy))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the derivative approximation</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> (f_plus_delta <span class="op">-</span> f_minus_delta) <span class="op">/</span> (<span class="fl">2</span> <span class="op">*</span> delta)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> W <span class="op">-&gt;</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W))</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="fu">finite_diff</span>(f, W, demo_edge, <span class="fl">0.01</span>), <span class="fu">finite_diff</span>(f, W, demo_edge,<span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>([2.413251884607348], [2.4135507160903513])</code></pre>
</div>
</div>
</section>
<section id="forward-differentiation" class="level2">
<h2 class="anchored" data-anchor-id="forward-differentiation">Forward Differentiation</h2>
<p>Results are derived in the numerator layout, which means that the dimensionality of the input is added to the right</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">forward_diff_j</span>(W<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Column indices for retrieval</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">CartesianIndices</span>(W))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    index_vec <span class="op">=</span> <span class="fu">sort</span>(<span class="fu">vec</span>(indices), by <span class="op">=</span> x <span class="op">-&gt;</span> x[<span class="fl">1</span>])</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diff_exp</span>(W) <span class="op">=</span> <span class="fu">exponential!</span>(<span class="fu">copyto!</span>(<span class="fu">similar</span>(W), W), <span class="fu">ExpMethodGeneric</span>())</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    J <span class="op">=</span> ForwardDiff.<span class="fu">jacobian</span>(diff_exp, W)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">length</span>(edges))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    tangent <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">permutedims</span>(<span class="fu">exp</span>(W), [<span class="fl">2</span>, <span class="fl">1</span>]))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_edge, edge) <span class="kw">in</span> <span class="fu">enumerate</span>(edges)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we get all partial derivative positions that are non-zero</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        Jₓ <span class="op">=</span> J[<span class="op">:</span>, <span class="fu">findfirst</span>(x <span class="op">-&gt;</span> x <span class="op">==</span> edge, index_vec)]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        results[i_edge] <span class="op">=</span> <span class="fu">sum</span>(Jₓ)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="fu">forward_diff_j</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>1-element Vector{Float64}:
 2.4132511356618336</code></pre>
</div>
</div>
</section>
<section id="forward-differentiation-with-jacobian-vector-product" class="level2">
<h2 class="anchored" data-anchor-id="forward-differentiation-with-jacobian-vector-product">Forward Differentiation with Jacobian vector product</h2>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">forward_diff_jvp</span>(W<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    tangent <span class="op">=</span> <span class="fu">ones</span>(<span class="fu">size</span>(W))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diff_exp</span>(W) <span class="op">=</span> <span class="fu">exponential!</span>(<span class="fu">copyto!</span>(<span class="fu">similar</span>(W), W), <span class="fu">ExpMethodGeneric</span>())</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">g</span>(t) <span class="op">=</span> <span class="fu">diff_exp</span>(W <span class="op">+</span> t <span class="op">*</span> tangent)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    JVP <span class="op">=</span> ForwardDiff.<span class="fu">derivative</span>(g, <span class="fl">0.0</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> JVP[edges]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">forward_diff_jvp</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>1-element Vector{Float64}:
 2.413251135661834</code></pre>
</div>
</div>
</section>
<section id="fréchet-block-enlarge" class="level2">
<h2 class="anchored" data-anchor-id="fréchet-block-enlarge">Fréchet: Block enlarge</h2>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">frechet_block_enlarge</span>(W<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    E <span class="op">=</span> <span class="fu">ones</span>(<span class="fu">size</span>(W))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="fu">size</span>(W, <span class="fl">1</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> [W E; <span class="fu">zeros</span>(<span class="fu">size</span>(W)) W]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    expm_M <span class="op">=</span> <span class="fu">exp</span>(M) </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    frechet_AE <span class="op">=</span> expm_M[<span class="fl">1</span><span class="op">:</span>n, n<span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frechet_AE[edges]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="fu">frechet_block_enlarge</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>1-element Vector{Float64}:
 2.413251135661833</code></pre>
</div>
</div>
</section>
<section id="fréchet-scaling-pade-squaring" class="level2">
<h2 class="anchored" data-anchor-id="fréchet-scaling-pade-squaring">Fréchet: Scaling-Pade-Squaring</h2>
The algorithm: $$
<span class="math display">\[\begin{array}{l}
\text{for } m = [3, 5, 7, 9] \\
\quad \quad \text{if } ||A||_{1} \leq \theta_{m} \\
\quad \quad \quad \quad r_{m}(A) \quad \text{ \textit{form Pade approximant to A}} \\
\quad \quad \quad \quad U, V     \quad \text{ \textit{Evaluate U and V, see below for }} r_{13} \\
\quad \quad \quad \quad s=0 \\
\quad \quad \quad \quad   \text{break} \\
\quad \quad \text{end} \\
\text{end} \\

\text{if } ||A||_{1} \geq  \theta_{m[-1]} \\
\quad \quad s = \text{ceil}(\log_{2}(||A||_{1}/ \theta_{13})) \\
\quad \quad A = A/2^{s} \\
\quad \quad A_{2} = A^{2}, A_{4} = A_{2}^{2}, A_{6} = A_{2}A_{4}\\
\quad \quad U = A[A_{6}(b_{13} A_{6} + b_{11} A_{4} + b_{9} A_{2}) + b_{7} A_{6} + b_{5} A_{4} + b_{3} A_{2} + b_{1} I]\\
\quad \quad V = A_{6}(b_{12}A_{6} + b_{10}A_{4} + b_{8}A_{2}) + b_{6}A_{6} + b_{4}A_{4} + b_{2}A_{2} + b_{0}I\\
\text{end} \\

\text{Solve } (-U+V)r_{m}(A) = U + V \text{ for } r_{m} \\
\text{for } k = 1:s \\
\quad \quad r_{m} = r_{m}*r_{m} \\
\text{end} \\
\text{return } r_{m} \\
\end{array}\]</span>
<p>$$</p>
<p>References:<br> Higham (2008), Functions of Matrices - Theory and Computation”, Chapter 10, Algorithm 10.20 <br> https://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.expm_frechet.html#scipy.linalg.expm_frechet <br> https://rdrr.io/cran/expm/man/expmFrechet.html</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade3</span>(A, E, ident)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">120.0</span>, <span class="fl">60.0</span>, <span class="fl">12.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade5</span>(A, E, ident)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">30240.0</span>, <span class="fl">15120.0</span>, <span class="fl">3360.0</span>, <span class="fl">420.0</span>, <span class="fl">30.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade7</span>(A, E, ident)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">17297280.0</span>, <span class="fl">8648640.0</span>, <span class="fl">1995840.0</span>, <span class="fl">277200.0</span>, <span class="fl">25200.0</span>, <span class="fl">1512.0</span>, <span class="fl">56.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    A6 <span class="op">=</span> A2 <span class="op">*</span> A4</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    M6 <span class="op">=</span> A4 <span class="op">*</span> M2 <span class="op">+</span> M4 <span class="op">*</span> A2</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">8</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade9</span>(A, E, ident)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">17643225600.0</span>, <span class="fl">8821612800.0</span>, <span class="fl">2075673600.0</span>, <span class="fl">302702400.0</span>, <span class="fl">30270240.0</span>, </span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>         <span class="fl">2162160.0</span>, <span class="fl">110880.0</span>, <span class="fl">3960.0</span>, <span class="fl">90.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    A6 <span class="op">=</span> A2 <span class="op">*</span> A4</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    M6 <span class="op">=</span> A4 <span class="op">*</span> M2 <span class="op">+</span> M4 <span class="op">*</span> A2</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    A8 <span class="op">=</span> A4 <span class="op">*</span> A4</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    M8 <span class="op">=</span> A4 <span class="op">*</span> M4 <span class="op">+</span> M4 <span class="op">*</span> A4</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">10</span>] <span class="op">*</span> A8 <span class="op">+</span> b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> b[<span class="fl">9</span>] <span class="op">*</span> A8 <span class="op">+</span> b[<span class="fl">7</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> (b[<span class="fl">10</span>] <span class="op">*</span> M8 <span class="op">+</span> b[<span class="fl">8</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2) <span class="op">+</span> E <span class="op">*</span> (b[<span class="fl">10</span>] <span class="op">*</span> A8 <span class="op">+</span> b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> b[<span class="fl">9</span>] <span class="op">*</span> M8 <span class="op">+</span> b[<span class="fl">7</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_diff_pade13</span>(A, E, ident)</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pade order 13</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    A2 <span class="op">=</span> A <span class="op">*</span> A</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    M2 <span class="op">=</span> A <span class="op">*</span> E <span class="op">+</span> E <span class="op">*</span> A</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    A4 <span class="op">=</span> A2 <span class="op">*</span> A2</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>    M4 <span class="op">=</span> A2 <span class="op">*</span> M2 <span class="op">+</span> M2 <span class="op">*</span> A2</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    A6 <span class="op">=</span> A2 <span class="op">*</span> A4</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    M6 <span class="op">=</span> A4 <span class="op">*</span> M2 <span class="op">+</span> M4 <span class="op">*</span> A2</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> (<span class="fl">64764752532480000</span>., <span class="fl">32382376266240000</span>., <span class="fl">7771770303897600</span>.,</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>            <span class="fl">1187353796428800</span>., <span class="fl">129060195264000</span>., <span class="fl">10559470521600</span>.,</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>            <span class="fl">670442572800</span>., <span class="fl">33522128640</span>., <span class="fl">1323241920</span>., <span class="fl">40840800</span>., <span class="fl">960960</span>.,</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>            <span class="fl">16380</span>., <span class="fl">182</span>., <span class="fl">1</span>.)</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    W1 <span class="op">=</span> b[<span class="fl">14</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">12</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">10</span>] <span class="op">*</span> A2</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    W2 <span class="op">=</span> b[<span class="fl">8</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">2</span>] <span class="op">*</span> ident</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    Z1 <span class="op">=</span> b[<span class="fl">13</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">11</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">9</span>] <span class="op">*</span> A2</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    Z2 <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> A6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> A4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> A2 <span class="op">+</span> b[<span class="fl">1</span>] <span class="op">*</span> ident</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> A6 <span class="op">*</span> W1 <span class="op">+</span> W2</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> A <span class="op">*</span> W</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> A6 <span class="op">*</span> Z1 <span class="op">+</span> Z2</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    Lw1 <span class="op">=</span> b[<span class="fl">14</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">12</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">10</span>] <span class="op">*</span> M2</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    Lw2 <span class="op">=</span> b[<span class="fl">8</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">6</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">4</span>] <span class="op">*</span> M2</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    Lz1 <span class="op">=</span> b[<span class="fl">13</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">11</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">9</span>] <span class="op">*</span> M2</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>    Lz2 <span class="op">=</span> b[<span class="fl">7</span>] <span class="op">*</span> M6 <span class="op">+</span> b[<span class="fl">5</span>] <span class="op">*</span> M4 <span class="op">+</span> b[<span class="fl">3</span>] <span class="op">*</span> M2</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    Lw <span class="op">=</span> A6 <span class="op">*</span> Lw1 <span class="op">+</span> M6 <span class="op">*</span> W1 <span class="op">+</span> Lw2</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    Lu <span class="op">=</span> A <span class="op">*</span> Lw <span class="op">+</span> E <span class="op">*</span> W</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>    Lv <span class="op">=</span> A6 <span class="op">*</span> Lz1 <span class="op">+</span> M6 <span class="op">*</span> Z1 <span class="op">+</span> Lz2</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, Lu, Lv</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>ell_table_61 <span class="op">=</span> (<span class="cn">nothing</span>, <span class="fl">2.11e-8</span>, <span class="fl">3.56e-4</span>, <span class="fl">1.08e-2</span>, <span class="fl">6.49e-2</span>, <span class="fl">2.00e-1</span>, <span class="fl">4.37e-1</span>,</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>        <span class="fl">7.83e-1</span>, <span class="fl">1.23e0</span>, <span class="fl">1.78e0</span>, <span class="fl">2.42e0</span>, <span class="fl">3.13e0</span>, <span class="fl">3.90e0</span>, <span class="fl">4.74e0</span>, <span class="fl">5.63e0</span>,</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>        <span class="fl">6.56e0</span>, <span class="fl">7.52e0</span>, <span class="fl">8.53e0</span>, <span class="fl">9.56e0</span>, <span class="fl">1.06e1</span>, <span class="fl">1.17e1</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">frechet_algo</span>(A<span class="op">::</span><span class="dt">Matrix{Float64}</span>, edges<span class="op">::</span><span class="dt">Vector{CartesianIndex{2}}</span>)<span class="op">::</span><span class="dt">Vector{Float64}</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    E <span class="op">=</span> <span class="fu">ones</span>(<span class="fu">size</span>(A))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="fu">size</span>(A, <span class="fl">1</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="cn">nothing</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    ident <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Float64}</span>(I, n, n)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    A_norm_1 <span class="op">=</span> <span class="fu">norm</span>(A, <span class="fl">1</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    m_pade_pairs <span class="op">=</span> [(<span class="fl">3</span>, _diff_pade3),(<span class="fl">5</span>, _diff_pade5),(<span class="fl">7</span>, _diff_pade7),(<span class="fl">9</span>, _diff_pade9)]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m, pade) <span class="kw">in</span> m_pade_pairs</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> A_norm_1 <span class="op">&lt;=</span> ell_table_61[m]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>            U, V, Lu, Lv <span class="op">=</span> <span class="fu">pade</span>(A, E, ident)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> s <span class="op">==</span> <span class="cn">nothing</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># scaling</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> <span class="fu">max</span>(<span class="fl">0</span>, <span class="fu">ceil</span>(<span class="dt">Int</span>, <span class="fu">log2</span>(A_norm_1 <span class="op">/</span> ell_table_61[<span class="fl">13</span>])))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        A <span class="op">*=</span> <span class="fl">2.0</span><span class="op">^-</span>s</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        E <span class="op">*=</span> <span class="fl">2.0</span><span class="op">^-</span>s</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        U, V, Lu, Lv <span class="op">=</span> <span class="fu">_diff_pade13</span>(A, E, ident)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># factor once and solve twice</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    lu_piv <span class="op">=</span> <span class="fu">lu</span>(<span class="op">-</span>U <span class="op">+</span> V)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> lu_piv <span class="op">\</span> (U <span class="op">+</span> V)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> lu_piv <span class="op">\</span> (Lu <span class="op">+</span> Lv <span class="op">+</span> ((Lu <span class="op">-</span> Lv) <span class="op">*</span> R))</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># repeated squaring</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>s</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        L <span class="op">=</span> R <span class="op">*</span> L <span class="op">+</span> L <span class="op">*</span> R</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        R<span class="op">=</span> R <span class="op">*</span> R</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L[edges]</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="fu">frechet_algo</span>(W, demo_edge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>1-element Vector{Float64}:
 2.413251135661833</code></pre>
</div>
</div>
</section>
</section>
<section id="benchmarking" class="level1">
<h1>Benchmarking <a name="benchmarking" href=""></a></h1>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">init_sparse_matrix</span>(n <span class="op">=</span> <span class="fl">100</span>, density <span class="op">=</span> <span class="fl">0.2</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize a sparse matrix</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> <span class="fu">zeros</span>(n, n)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n, j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">rand</span>() <span class="op">&lt;</span> (density <span class="op">/</span> <span class="fl">2</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            W[i, j] <span class="op">=</span> W[j,i] <span class="op">=</span> <span class="fu">rand</span>()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> W</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>W_bench <span class="op">=</span> <span class="fu">init_sparse_matrix</span>(<span class="fl">50</span>, <span class="fl">0.10</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>edges_bench <span class="op">=</span> <span class="fu">findall</span>(x <span class="op">-&gt;</span> x <span class="op">!=</span> <span class="fl">0</span>, W_bench)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> (W, _) <span class="op">-&gt;</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W))</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">tangent_approx</span>(f, <span class="op">$</span>W_bench, <span class="op">$</span>edges_bench, <span class="fl">0.01</span>) </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">finite_diff</span>(f, <span class="op">$</span>W_bench, <span class="op">$</span>edges_bench, <span class="fl">0.1</span>) </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">forward_diff_j</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench) </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">forward_diff_jvp</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench) </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">frechet_block_enlarge</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench) </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">frechet_algo</span>(<span class="op">$</span>W_bench, <span class="op">$</span>edges_bench);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  581.718 ms (76375 allocations: 430.55 MiB)
  101.404 ms (8809 allocations: 68.82 MiB)
  1.727 s (6158 allocations: 312.79 MiB)
  1.502 ms (20 allocations: 315.55 KiB)
  2.286 ms (24 allocations: 609.88 KiB)
  397.250 μs (220 allocations: 1.86 MiB)</code></pre>
</div>
</div>
</section>
<section id="extension-to-full-objective-function" class="level1">
<h1>Extension to full objective function</h1>
<p>Currently I can successfully compute the objective function derivative without normalization. This brings a tremendous speedup, demonstrated below on the dataset provided by Akarca in the demo repo. Will need to spend some more time on the derivative with the normalization.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load synthetic data</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>W_Y, D, A_init <span class="op">=</span> <span class="fu">load_weight_test_data</span>()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>A_Y <span class="op">=</span> <span class="fu">Float64</span>.(W_Y <span class="op">.&gt;</span> <span class="fl">0</span>);</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>α <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>ω <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>ϵ <span class="op">=</span> <span class="fl">1e-5</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>m_seed <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">sum</span>(A_init))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>m_all <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">sum</span>(A_Y))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>resolution <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>steps <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>zero_indices <span class="op">=</span> <span class="fu">findall</span>(<span class="op">==</span>(<span class="fl">0</span>), <span class="fu">triu</span>(A_init, <span class="fl">1</span>))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>edges_to_add <span class="op">=</span> <span class="fu">sample</span>(zero_indices, m_all<span class="op">-</span>m_seed; replace <span class="op">=</span> <span class="cn">false</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">test_tangent</span>(m_max<span class="op">::</span><span class="dt">Int</span>, normalize<span class="op">::</span><span class="dt">Bool</span>, verbose<span class="op">::</span><span class="dt">Bool</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    A_current <span class="op">=</span> <span class="fu">copy</span>(A_init)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    W_current <span class="op">=</span> <span class="fu">copy</span>(A_init)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> normalize</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">function</span> <span class="fu">f</span>(W, edge_idx)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>            node_strengths <span class="op">=</span> <span class="fu">dropdims</span>(<span class="fu">sum</span>(W, dims<span class="op">=</span><span class="fl">2</span>), dims<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>            node_strengths[node_strengths<span class="op">.==</span><span class="fl">0</span>] <span class="op">.=</span> ϵ</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>            norm_fact <span class="op">=</span> <span class="fu">sqrt</span>(<span class="fu">inv</span>(<span class="fu">Diagonal</span>(node_strengths)))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (<span class="fu">sum</span>(<span class="fu">exp</span>(norm_fact <span class="op">*</span> W <span class="op">*</span> norm_fact)))</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (<span class="fu">sum</span>(<span class="fu">exp</span>(norm_fact <span class="op">*</span> W <span class="op">*</span> norm_fact)) <span class="op">*</span> D[edge_idx])<span class="op">^</span>ω</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    else</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> (W, edge_idx) <span class="op">-&gt;</span> (<span class="fu">sum</span>(<span class="fu">exp</span>(W))  <span class="op">*</span> D[edge_idx])<span class="op">^</span>ω</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>m_max</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the edge</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        edge_idx <span class="op">=</span> edges_to_add[m<span class="op">-</span>m_seed]</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        rev_idx <span class="op">=</span> <span class="fu">CartesianIndex</span>(edge_idx[<span class="fl">2</span>], edge_idx[<span class="fl">1</span>])</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        A_current[edge_idx] <span class="op">=</span> W_current[edge_idx] <span class="op">=</span>  <span class="fl">1</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        A_current[rev_idx] <span class="op">=</span> W_current[rev_idx] <span class="op">=</span>  <span class="fl">1</span>    </span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        edge_indices <span class="op">=</span> <span class="fu">findall</span>(<span class="op">!=</span>(<span class="fl">0</span>), <span class="fu">triu</span>(A_current, <span class="fl">1</span>))</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        tangent_d <span class="op">=</span> <span class="fu">tangent_approx</span>(f, W_current, edge_indices, resolution, steps)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">println</span>(<span class="fu">round</span>.(tangent_d, digits<span class="op">=</span><span class="fl">6</span>))</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_edge, edge) <span class="kw">in</span> <span class="fu">enumerate</span>(edge_indices)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>            W_current[edge] <span class="op">-=</span> (α <span class="op">*</span> tangent_d[i_edge])</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>            W_current[edge] <span class="op">=</span> <span class="fu">max</span>(<span class="fl">0</span>, W_current[edge])</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>            W_current[<span class="fu">CartesianIndex</span>(edge[<span class="fl">2</span>], edge[<span class="fl">1</span>])] <span class="op">=</span> W_current[edge]</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> W_current</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">test_frechet_algo</span>(m_max<span class="op">::</span><span class="dt">Int</span>, normalize<span class="op">::</span><span class="dt">Bool</span>, verbose<span class="op">::</span><span class="dt">Bool</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    A_current <span class="op">=</span> <span class="fu">copy</span>(A_init)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    W_current <span class="op">=</span> <span class="fu">copy</span>(A_init)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>m_max</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the edge</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        edge_idx <span class="op">=</span> edges_to_add[m<span class="op">-</span>m_seed]</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        rev_idx <span class="op">=</span> <span class="fu">CartesianIndex</span>(edge_idx[<span class="fl">2</span>], edge_idx[<span class="fl">1</span>])</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        A_current[edge_idx] <span class="op">=</span> W_current[edge_idx] <span class="op">=</span>  <span class="fl">1</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        A_current[rev_idx] <span class="op">=</span> W_current[rev_idx] <span class="op">=</span>  <span class="fl">1</span>    </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        edge_indices <span class="op">=</span> <span class="fu">findall</span>(<span class="op">!=</span>(<span class="fl">0</span>), <span class="fu">triu</span>(A_current, <span class="fl">1</span>))</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> normalize</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            node_strengths <span class="op">=</span> <span class="fu">dropdims</span>(<span class="fu">sum</span>(W_current, dims<span class="op">=</span><span class="fl">2</span>), dims<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            node_strengths[node_strengths<span class="op">.==</span><span class="fl">0</span>] <span class="op">.=</span> ϵ</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>            norm_fact <span class="op">=</span> <span class="fu">Matrix</span>(<span class="fu">sqrt</span>(<span class="fu">inv</span>(<span class="fu">Diagonal</span>(node_strengths))))</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>            frechet_d <span class="op">=</span> <span class="fu">frechet_algo</span>(norm_fact <span class="op">*</span> W_current <span class="op">*</span> norm_fact, edge_indices)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">#println(round.(frechet_algo(norm_fact, edge_indices), digits=5))</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> </span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>            current_Y <span class="op">=</span> <span class="fu">sum</span>(<span class="fu">exp</span>(W_current))</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            frechet_d <span class="op">=</span> <span class="fu">frechet_algo</span>(W_current, edge_indices)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            frechet_d <span class="op">=</span> [ω <span class="op">*</span> D[edge]<span class="op">^</span>ω  <span class="op">*</span> frechet_d[i_edge] <span class="op">*</span> current_Y<span class="op">^</span>(ω<span class="op">-</span><span class="fl">1</span>) for (i_edge, edge) <span class="kw">in</span> <span class="fu">enumerate</span>(edge_indices)]</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">println</span>(<span class="fu">round</span>.(frechet_d, digits<span class="op">=</span><span class="fl">2</span>))</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_edge, edge) <span class="kw">in</span> <span class="fu">enumerate</span>(edge_indices)</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>            W_current[edge] <span class="op">-=</span> (α <span class="op">*</span> frechet_d[i_edge])</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>            W_current[edge] <span class="op">=</span> <span class="fu">max</span>(<span class="fl">0</span>, W_current[edge])</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>            W_current[<span class="fu">CartesianIndex</span>(edge[<span class="fl">2</span>], edge[<span class="fl">1</span>])] <span class="op">=</span> W_current[edge]</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> W_current</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> W_res_tangent <span class="op">=</span> <span class="fu">test_tangent</span>(<span class="fl">40</span>, <span class="cn">false</span>, <span class="cn">false</span>);</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> W_res_frechet <span class="op">=</span> <span class="fu">test_frechet_algo</span>(<span class="fl">40</span>, <span class="cn">false</span>, <span class="cn">false</span>);</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">abs</span>.(W_res_tangent <span class="op">.-</span> W_res_frechet))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 46.037512 seconds (571.76 k allocations: 2.844 GiB, 0.49% gc time, 0.27% compilation time)
  0.840606 seconds (97.03 k allocations: 120.649 MiB, 2.29% gc time, 5.58% compilation time)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>2.4292371921252887e-5</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @time W_res_tangent = test_tangent(5, true);</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># @time W_res_frechet = test_frechet_algo(5, true);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>